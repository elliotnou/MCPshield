"""Auto-generated MCP server for {{ title }}.

Generated by MCP Adapter Generator v{{ generator_version }}
API version: {{ api_version }}
Base URL: {{ base_url }}
"""

from __future__ import annotations

import asyncio
import json
import os
from typing import Any

import httpx
from dedalus_mcp import MCPServer, tool


# ── Configuration ───────────────────────────────────────────────────────────

BASE_URL = os.getenv("{{ env_prefix }}_BASE_URL", "{{ base_url }}")
API_KEY = os.getenv("{{ env_prefix }}_API_KEY", "")

{% if auth_header %}
AUTH_HEADER = "{{ auth_header }}"
{% else %}
AUTH_HEADER = "Authorization"
{% endif %}
{% if auth_scheme %}
AUTH_SCHEME = "{{ auth_scheme }}"
{% else %}
AUTH_SCHEME = "Bearer"
{% endif %}


def _headers() -> dict[str, str]:
    h: dict[str, str] = {"Content-Type": "application/json", "Accept": "application/json"}
    if API_KEY:
        h[AUTH_HEADER] = f"{AUTH_SCHEME} {API_KEY}"
    return h


async def _request(
    method: str,
    path: str,
    *,
    params: dict[str, Any] | None = None,
    body: dict[str, Any] | None = None,
) -> str:
    """Make an HTTP request to the upstream API and return the response text."""
    url = f"{BASE_URL}{path}"
    async with httpx.AsyncClient(timeout=30.0) as client:
        resp = await client.request(
            method,
            url,
            headers=_headers(),
            params=params,
            json=body if body else None,
        )
        resp.raise_for_status()
        try:
            data = resp.json()
            return json.dumps(data, indent=2)
        except Exception:
            return resp.text


# ── Tools ───────────────────────────────────────────────────────────────────

{% for tool_def in tools %}

@tool(description={{ tool_def.description | tojson }})
async def {{ tool_def.name }}({{ tool_def.params | join(', ') }}) -> str:
    """{{ tool_def.description }}"""
    {% if tool_def.endpoint %}
    path = f"{{ tool_def.path_template }}"
    {% if tool_def.method == "GET" %}
    params: dict[str, Any] = {}
    {% for p in tool_def.query_params %}
    if {{ p.name }} is not None:
        params["{{ p.name }}"] = {{ p.name }}
    {% endfor %}
    return await _request("GET", path, params=params if params else None)
    {% elif tool_def.method in ("POST", "PUT", "PATCH") %}
    body: dict[str, Any] = {}
    {% for p in tool_def.body_params %}
    if {{ p.name }} is not None:
        body["{{ p.name }}"] = {{ p.name }}
    {% endfor %}
    {% if tool_def.query_params %}
    params: dict[str, Any] = {}
    {% for p in tool_def.query_params %}
    if {{ p.name }} is not None:
        params["{{ p.name }}"] = {{ p.name }}
    {% endfor %}
    return await _request("{{ tool_def.method }}", path, params=params if params else None, body=body if body else None)
    {% else %}
    return await _request("{{ tool_def.method }}", path, body=body if body else None)
    {% endif %}
    {% elif tool_def.method == "DELETE" %}
    return await _request("DELETE", path)
    {% else %}
    return await _request("{{ tool_def.method }}", path)
    {% endif %}
    {% endif %}

{% endfor %}

# ── Server ──────────────────────────────────────────────────────────────────

server = MCPServer("{{ server_name }}")
server.collect({{ tool_names | join(', ') }})

if __name__ == "__main__":
    asyncio.run(server.serve())
